let productos = [
	{
	  "id": "menu1Cant",
      "name": "Menú cervecera",
      "prize": 22,
     "kcal": 100
    }, 
	{
	  "id": "menu2Cant",
      "name": "Menú chuletón",
      "prize": 28,
     "kcal": 487
    }, 
	{
	  "id": "menu3Cant",
      "name": "Menú arroz con bogavante",
      "prize": 28,
      "kcal": 328
    }, 
	{
	  "id": "menu4Cant",	
      "name": "Menú alubiada",
      "prize": 22,
      "kcal": 419
    }, 
	{
	  "id": "menu5Cant",	
      "name": "Menú infantil rojo",
      "prize": 6.50,
      "kcal": 145
    }, 
	{
	  "id": "menu6Cant",	
      "name": "Menú infantil azul",
      "prize": 6.50,
      "kcal": 137
    }, 
	{
	  "id": "menu7Cant",	
      "name": "Menú infantil blanco",
      "prize": 6.50,
      "kcal": 171
    }, 
    {
      "id": "menu8Cant",	
        "name": "Menú infantil verde",
        "prize": 6.50,
        "kcal": 161
      }, 
    {
	  "id": "menu9Cant",	
      "name": "Ceviche de corvina",
      "prize": 7.45,
      "kcal": 120
    }, 
	{
	  "id": "menu10Cant",	
      "name": "Marmitako de atún",
      "prize": 5.95,
      "kcal": 100
    }, 
	{
	  "id": "menu11Cant",	
      "name": "Alubias con sacramentos",
      "prize": 6.95,
      "kcal": 177
    }, 
	{
	  "id": "menu12Cant",	
      "name": "Pollo al chilindrón",
      "prize": 6.25,
      "kcal": 209
    }, 
	{
	  "id": "menu13Cant",	
      "name": "Espinacas con pollo y anacardos",
      "prize": 5.35,
      "kcal": 195
    }, 
	{
	  "id": "menu14Cant",	
      "name": "Carrillada con arroz salvaje",
      "prize": 6.85,
      "kcal": 179
    }, 
	{
	  "id": "menu15Cant",	
      "name": "Morcillo con puré de patata",
      "prize": 6.40,
      "kcal": 131
    }, 
	{
	  "id": "menu16Cant",	
      "name": "Pollo curry con verduras y arroz",
      "prize": 4.60,
      "kcal": 186
    }, 
	{
	  "id": "menu17Cant",	
      "name": "Potaje de garbanzos y bacalao",
      "prize": 5.65,
      "kcal": 119
    }, 
	{
	  "id": "menu18Cant",	
      "name": "Cuscus de verduras",
      "prize": 6.25,
      "kcal": 103
    }, 
	{
	  "id": "menu19Cant",	
      "name": "Lasaña de carne de ternera",
      "prize": 7.65,
      "kcal": 205
    }, 
	{
	  "id": "menu20Cant",	
      "name": "Lentejas con verdura",
      "prize": 5.25,
      "kcal": 99
    }, {
	  "id": "menu21Cant",	
      "name": "Arroz con pollo",
      "prize": 6.75,
      "kcal": 110
    }, 
	{
	  "id": "menu22Cant",	
      "name": "Crema de guisantes",
      "prize": 4.50,
      "kcal": 80
    }, 
	{
	  "id": "menu23Cant",	
      "name": "Arroz meloso con rape y gambas",
      "prize": 6.25,
      "kcal": 180
    }, 
	{
	  "id": "menu24Cant",	
      "name": "Arroz al horno con queso y setas shiitake",
      "prize": 7.25,
      "kcal": 183
    }, 
	{
	  "id": "menu25Cant",	
      "name": "Bornos Frizzante Verdejo",
      "prize": 12.50,
      "kcal": 120
    }, 
	{
	  "id": "menu26Cant",	
      "name": "Mar de Frades",
      "prize": 14.00,
      "kcal": 100
    }, 
	{
	  "id": "menu27Cant",	
      "name": "Viña Pomal crianza",
      "prize": 9.00,
      "kcal": 160
    }, 
	{
	  "id": "menu28Cant",	
      "name": "Cerveza Duchesse de Bourgogne",
      "prize": 2.80,
      "kcal": 170
    }, 
	{
	  "id": "menu29Cant",	
      "name": "Cerveza Birra Moretti",
      "prize": 1.21,
      "kcal": 140
    },
	{
	  "id": "menu30Cant",	
      "name": "Refresco de cola",
      "prize": 0.60,
      "kcal": 120
    }, 
	{
	  "id": "menu31Cant",	
      "name": "Refresco de naranja",
      "prize": 0.60,
      "kcal": 120
    }, 
	{
	  "id": "menu32Cant",	
      "name": "Refresco de limón",
      "prize": 0.60,
      "kcal": 120
    }, 
	{
	  "id": "menu33Cant",	
      "name": "Botellín de agua",
      "prize": 0.40,
      "kcal": 0
    }, 
	{
	  "id": "menu34Cant",	
      "name": "Barra de pan blanco",
      "prize": 1.00,
      "kcal": 60
    }, 
	{
	  "id": "menu35Cant",	
      "name": "Barra de pan integral",
      "prize": 1.15,
      "kcal": 40
    }, 
	{
	  "id": "menu36Cant",	
      "name": "Salsa ali-oli",
      "prize": 1.00,
      "kcal": 100
    }, 
	{
	  "id": "menu37Cant",	
      "name": "Salsa barbacoa",
      "prize": 1.15,
      "kcal": 200
    }, 
	{
	  "id": "menu38Cant",	
      "name": "Mostaza",
      "prize": 0.90,
      "kcal": 140
    }, 
	{
	  "id": "menu39Cant",	
      "name": "Mahonesa",
      "prize": 0.90,
      "kcal": 114
    }, 
	{
	  "id": "menu40Cant",	
      "name": "Ración de patatas",
      "prize": 1.50,
      "kcal": 190
    }, 
	{
	  "id": "menu41Cant",	
      "name": "Ración de calamares",
      "prize": 2.00,
      "kcal": 210
    }, 
	{
	  "id": "menu42Cant",	
      "name": "Flan de queso",
      "prize": 1.00,
      "kcal": 110
    }, 
	{
	  "id": "menu43Cant",	
      "name": "Cuajada",
      "prize": 0.90,
      "kcal": 100
    }, 
	{
	  "id": "menu44Cant",	
      "name": "Natillas de galleta",
      "prize": 1.00,
      "kcal": 175
    }, 
	{
	  "id": "menu45Cant",	
      "name": "Tarta de queso",
      "prize": 1.40,
      "kcal": 250
    },
	{
	  "id": "menu46Cant",	
      "name": "Tarta de fresa",
      "prize": 1.00,
      "kcal": 175
	}
]

/**
 * Realiza el cálculo del precio del menú y de las calorías que supone lo que se ha seleccionado.
 * En caso de que alguno de los campos de entrada esté vacío se mostrará un error y se pondrá 
 * el foco en el campo que no se ha rellenado.
 * @returns {boolean}
 */
function realizarCalculoPrecioCalorias() {
    var oForm = document.forms[0];
    var precioTotal = 0.0;
    var caloriasTotales = 0;
    var hayError = false;
    for (var i=0, iLen=oForm.length; i<iLen; i++) {
        if (oForm[i].id.startsWith("menu"))
        {
          let producto = productos.filter(producto => producto.id === oForm[i].id);
          if (oForm[i].value.trim().length == 0) 
          {
              //Ponemos el foco en el campo que no se ha rellenado
              oForm[i].focus();

              //Mostramos el error y ponemos el foco en el campo que no se ha rellenado ya que al
              //clicar en el botón de cerrar pierde el foco.
              mostrarError(oForm[i], " Por favor rellena el campo: " + producto[0].name);

              //Voy recorriendo el DOM hasta llegar al nodo details y lo expando.
              oForm[i].parentNode.parentNode.parentNode.parentNode.parentNode.open = true;

              //Establezco que hay error para hacer la suma o no.
              hayError = true;
              
              //Salimos del bucle ya que hay un error y no sequimos procesando.
              break;
          } else {
            //Sumamos el valor del producto elegido y las calorías del mismo.
            //Podríamos evitar el if y el resultado sería el mismo pero así evitamos un
            //cálculo innecesario.
            if (oForm[i].value > 0) {
              //Si es mayor que cero lo sumamos.
              precioTotal += producto[0].prize * oForm[i].value;
              caloriasTotales += producto[0].kcal * oForm[i].value;
            }
          }
        }
    }

    if (!hayError) {
      //Asignamos a los campos lo calculado
      document.getElementById("precioTotal").value=precioTotal;
      document.getElementById("caloriasTotal").value=caloriasTotales;
    } else {
      //Como hay un error seteamos a cero el precio y la calorias
      document.getElementById("precioTotal").value=0;
      document.getElementById("caloriasTotal").value=0;    
    }

    return false;
}

/**
 * Comprueba que el formato del nif es correcto.
 * Tiene entre 4 y 9 dígitos, seguidos de un guión y una letra
 * @param {string} nifValue - El valor del nif a validar.
 * @returns {boolean} - True si el nif es correcto, false en caso contrario
 */
function checkNif(nifValue) {
  //Comprobamos que la cadena tiene una longitud entre 6 y 11
  if (nifValue.length >=6 && nifValue.length <= 11) 
  {
    //Usamos una expresión regular para comprobar que cumple con el patrón establecido
    //Con esta expresión no sería necesario comprobar la longitud
    var patron = /^([0-9]{4,9})-([A-Z]{1})$/i;
    return patron.test(nifValue);
  } else {
    return false;
  }
}

/**
 * Comprueba que el formato de la dirección de correo electrónica
 * es válida.
 * Tiene una arroba, letras antes y después de este y algún punto.
 * @param {string} emailValue - El valor del correo a validar.
 * @returns {boolean} - True si el formato es correcto
 */
 function checkEmail(emailValue) {
    //Usamos una expresión regular para comprobar que cumple con el patrón establecido
    var patron = /^([A-Z0-9.]+)@([A-Z0-9]+\.)+([A-Z0-9]+)$/i;
    return patron.test(emailValue);
  }

 /**
 * Comprueba que el formato del teléfono es correcto.
 * Tiene 9 dígitos.
 * @param {string} telefonoValue - El valor del teléfono a validar.
 * @returns {boolean} - True si el formato es correcto
 */
 function checkTfno(telefonoValue) {
  //Usamos la funcion isNaN para ver que es un número y comprobamos la longitud.
  //Se podría haber hecho con una expresión regular ^([0-9]{9}) también.
  return (telefonoValue.length == 9) && (!isNaN(telefonoValue));
}

/**
 * Comprueba que la fecha y hora de solicitud de la entrega es como mínimo posterior
 * al momento actual
 * @param {string} fechaPedido - Fecha de entrega del pedido 
 * @param {string} horaPedido - Hora de entrega del pedido
 * @returns {boolean} - True si la hora y fecha de pedidi son posteriores a la actual
 */
function checkFechaHoraPedido(fechaPedido, horaPedido) {
  var fechaPedido = new Date(fechaPedido + " " + horaPedido);
  var ahora = new Date();
  //Si la fecha d pedido es mayor que ahora
  return fechaPedido > ahora;
}

/**
 * Comprobamos que el formato de la tarjeta bancaria es correcto.
 * 16 dígitos del número de tarjeta, la fecha de caducidad DD/MM y los 3 dígitos del código de seguridad.
 * @param {string} ccc - 16 dígitos de la tarjeta bancaria
 * @param {string} caducidad - Fecha de caducidad de la tarjeta DD/MM
 * @param {number} cvv - Código de verificación de la tarjeta
 * @returns {boolean} - True si el formato de la tarjeta es correcto
 */
function checkTarjetaBancaria(ccc, caducidad, cvv) {
  //Primero comprobamos que el ccc tiene 16 caracteres y es un número
  var cccCorrecto = true;
  if (ccc.length != 16 || isNaN(ccc)) {
    cccCorrecto = false;
  }

  //Hay que comprobar que la caducidad son dos números una barra y dos números
  //Para ello uso una expresión regular
  var caducCorrecto = true;
  var patronCaduc = /^([0-9]){2}\/([0-9]{2})$/;
  if (patronCaduc.test(caducidad)) {
    //Ahora vamos a comprobar que los primeros dos dígitos están entre 01 y 12 y que los años están dentro del rango
    //Del 21 al 26
    var datosCaduc = caducidad.split("/");
    var mes = datosCaduc[0];
    var anyo = datosCaduc[1];
    if (mes < 1 || mes > 12)
    {
      caducCorrecto = false;
    }

    if (anyo < 21 || anyo > 26)
    {
      caducCorrecto = false;
    }
  } else {
    caducCorrecto = false;
  }

  var cvvCorrecto = true;
  //Comprobamos que el cvv son tres dígitos, para ello usamos una expresion regular
  var patronCVV = /^([0-9]{3})/;
  if (!patronCVV.test(cvv)) {
    cvvCorrecto = false;
  }

  //Para considerar que la tarjeta cumple con el formato los tres elementos tienen que ser correctos.
  return cccCorrecto && caducCorrecto && cvvCorrecto;
}

/**
 * Comprobamos que todos los input del formulario se ha rellenado.
 * En caso de encontrar uno que no esté relleno hacemos foco en él y paramos la comprobación.
 * Retornamos un false en ese caso.
 * @param {FormData} oForm - Es el formulario a validar
 * @returns {boolean} - True si todos los datos se han rellenado.
 */
function comprobarCamposFormulario(oForm) {
  var isDatosCorrectos = true;
  for (var i=0, iLen=oForm.length; i<iLen; i++) {
      if ((oForm[i].type != "button") && (oForm[i].type != "fieldset")) {
        if (oForm[i].value.trim().length == 0) 
        {
            //Ponemos el foco en el campo que no se ha rellenado
            oForm[i].focus();

            if (oForm[i].id.startsWith("menu")) {
              //En el caso de que el elemento comience por el id menu es de los que están en el tag
              //details y puede estar colapsado por lo que hago lo siguiente para expandirlo.
              //Voy recorriendo el DOM hasta llegar al nodo details y lo expando.
              oForm[i].parentNode.parentNode.parentNode.parentNode.parentNode.open = true;
            }

            //Mostramos el mensaje de error
            mostrarError(oForm[i], " Por favor rellena el campo: " + oForm[i].name);
            isDatosCorrectos = false;
            //Salimos del bucle for
            break;
        }
      }
  }
  return isDatosCorrectos
}

/**
 * Comprueba que se ha seleccionado algún producto de la carta
 * @param {form} oForm - Formulario con los datos
 * @returns {boolean} - True si se han seleccionado productos
 */
function hayProductos(oForm) {
  var totalProductos = 0;
  for (var i=0, iLen=oForm.length; i<iLen; i++) {
    if (oForm[i].id.startsWith("menu"))
    {
      totalProductos += oForm[i].value;
    }
  }
  return (totalProductos > 0);
}

/**
 * Si se cumplen todas las condiciones establecidas, que los campos se han rellenado, algunos campos
 * cumplen con el formato adecuado y hay algún producto seleccionado entonces envía los datos.
 */
function realizarPedido() {
  //Como solo tenemos un formulario lo recuperamos de esta forma:
  var oForm = document.forms[0];
  var fechaPedido = oForm.fecha.value;
  var horaPedido = oForm.hora.value;
  var ccc = oForm.ccc.value;
  var cvv = oForm.cvv.value;
  var fechaCaducidad = oForm.cccMesCaduc.value + "/" + oForm.cccAnyoCaduc.value;

  //Comprobación del formato de un nif
  if (!checkNif(oForm.nif.value.trim())) {
    oForm.nif.focus();
    mostrarError(oForm.nif,"El nif no cumple con el formato.");
  } else if (!checkEmail(oForm.email.value)) {
    //Comprobación de que la dirección de correo electrónico es válida
    oForm.email.focus();
    mostrarError(oForm.email,"La dirección de correo no cumple con el formato.");
  } else if (!checkTfno(oForm.telefono.value)) {
    //Comprobación del formato del teléfono
    oForm.telefono.focus();
    mostrarError(oForm.telefono,"El número de teléfono no cumple con el formato.");
  } else if (!checkFechaHoraPedido(fechaPedido, horaPedido)) {
    //Comprobar que la fecha y hora de solicitud de la entrega es posterior al momento actual
    var hoy = new Date();
    var fPedido = new Date(fechaPedido);
    if (hoy.setHours(0,0,0,0) <= fPedido.setHours(0,0,0,0)) {
      oForm.hora.focus();
      mostrarError(oForm.hora,"La hora de pedido debe ser mayor que la hora actual.");
    } else {
      oForm.fecha.focus();
      mostrarError(oForm.fecha,"La fecha de pedido debe ser mayor o igual que la fecha actual.");
    }
  } else if (!checkTarjetaBancaria(ccc, fechaCaducidad,cvv)) {
    //Comprobar que el formato de la tarjeta bancaria es correcto
    //Comprobar que la fecha y hora de solicitud de la entrega es posterior al momento actual
    oForm.ccc.focus();
    mostrarError(oForm.ccc,"El formato de la tarjeta bancaria es incorrecto. Revise el CCC, CVV y la fecha.");
  } else if(!hayProductos(oForm)) {
    //Voy recorriendo el DOM hasta llegar al nodo details y lo expando.
    oForm.menu1Cant.parentNode.parentNode.parentNode.parentNode.parentNode.open = true;
    mostrarError(oForm.menu1Cant,"Para hacer un pedido tienes que seleccionar algún producto.");
  } else if (comprobarCamposFormulario(oForm)) {
    //Compruebo que todos los campos del formulario están rellenados.
    //Y como todo está correcto enviamos el formulario.
    oForm.submit();
  } 
}

/**
 * Función que muestra un mensaje de error indicando que debe rellenar el campo que se pasa por parámetro
 * a la función. Ese campo recifirá el foco una vez cerrada la ventana de error que la mostraré como modal.
 * @param {input} campoConError - Campo que recibirá el foco ya que no se ha rellenado.
 */
function mostrarError(campoConError, mensajeError) {
  //Obtenemos la capa que muestra el error y la mostramos
  var capaError = document.getElementById("error");
  capaError.style.display = "block";

  //Añadimos el mensaje de error
  document.getElementById("errorMsg").innerHTML = mensajeError;

  //Obtenemos el botón de cerrar
  var btnCerrar = document.getElementsByClassName("close")[0];

  //Añadimos a la capa el evento onClick para poder cerrarla al pulsar la equis
  btnCerrar.onclick = function() {
    capaError.style.display = "none";
    //Detectado que perdía el foco al cerrar la ventana de errores lo añado
    campoConError.focus();
  }  
}
